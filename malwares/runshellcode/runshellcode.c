#include <windows.h>
#include <stdio.h>


char stay[] = "stay";
int ret;

int main(int argc, char **argv) {

  if ( argc != 3 ) { /* argc should be 2 for correct execution */
    printf( "Execute a Shellcode\n" );
    printf( "usage: %s (stay|leave) filename", argv[0] );
    printf( "\n");
    printf( "stay never quit after shellcode exec\n" );
    printf( "leave if the shellcode returns, stop\n" );
    return(1);
  }
  
  FILE *file;
  char *buffer;
  unsigned long fileLen;

  // Stay or not...
  ret = strcmp(stay, argv[1]);
  if(ret = 0) {
    printf("str1 is equal to str2\n");
  }

  //Open file
  file = fopen(argv[2], "rb");
  if (!file) {
    fprintf(stderr, "Unable to open file %s", argv[2]);
    return(2);
  }

  //Get file length
  fseek(file, 0, SEEK_END);
  fileLen=ftell(file);
  fseek(file, 0, SEEK_SET);

  //Allocate memory for the file
  buffer=(char *)malloc(fileLen+1);
  if (!buffer)
  {
    fprintf(stderr, "Memory error!");
    fclose(file);
    return(3);
  }

  //Read file contents into buffer
  fread(buffer, fileLen, 1, file);
  fclose(file);

  //Do what ever with buffer, allocate RWX memory
  void *exec = VirtualAlloc(0, fileLen+1, MEM_COMMIT, PAGE_EXECUTE_READWRITE);

  printf("%08x wip\n", *&exec);
  // Copy the buffer in the RWX memory
  memcpy(exec, buffer, fileLen+1);

  asm ("nop\n\t"
       "nop\n\t"
       "nop\n\t"
       "nop\n\t"
       "nop\n\t"
       "nop\n\t");

  // Jump in the code
  ((void(*)())exec)();

  if(ret = 0) {
    while(1){
       Sleep(1000);
  }
}


 // Probably will never come back here.
  free(buffer);
  return(0);

}
